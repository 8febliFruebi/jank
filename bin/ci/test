#/usr/bin/env bash

set -eu

# TODO: CI support for address sanitization.
# TODO: CI support for release build.
# TODO: CI support for macOS.

cling_dir="build/cling-build/builddir"
if [[ ! -d "${cling_dir}" ]];
then
  ./bin/build-cling "${cling_dir}"
fi

./bin/configure -GNinja -DCMAKE_BUILD_TYPE=Debug -Djank_tests=on -Djank_coverage=on -Dcling_dir="${cling_dir}"
./bin/compile

# Collect code coverage while testing.
LLVM_PROFILE_FILE=build/test.profraw ./bin/test
llvm-profdata-14 merge --sparse build/test.profraw -o build/test.profdata
llvm-cov-14 show ./build/jank-test --instr-profile build/test.profdata > coverage.txt
bash <(curl -s https://codecov.io/bash) -f coverage.txt
